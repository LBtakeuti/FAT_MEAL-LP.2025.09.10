# ユーザー認証・ログイン機能セットアップガイド

## 概要

このガイドでは、ふとるめしLPサイトに実装されたユーザー認証・ログイン機能のセットアップ方法を説明します。

## 実装された機能

1. **ユーザー認証システム**
   - ログイン/新規登録機能
   - Supabase Authを使用した認証
   - セッション管理

2. **マイページ**
   - 会員情報の登録・更新
   - カート機能の管理

3. **ヘッダー統合**
   - ログイン状態の表示
   - ログイン/ログアウトボタン

## データベースセットアップ

### 1. SupabaseでSQLを実行

`supabase-user-schema.sql` ファイルの内容をSupabaseのSQL Editorで実行してください。

このSQLファイルは以下を作成します：
- `user_profiles` テーブル（ユーザープロフィール情報）
- `carts` テーブル（ユーザーのカート）
- `cart_items` テーブル（カート内の商品）
- Row Level Security (RLS) ポリシー
- 自動トリガー関数

### 2. 実行手順

1. Supabaseダッシュボードにログイン
2. 「SQL Editor」を開く
3. `supabase-user-schema.sql` の内容をコピー＆ペースト
4. 「Run」ボタンをクリックして実行

## 環境変数

既存の環境変数に追加の設定は不要です。Supabaseの環境変数が設定されていれば動作します：

```env
NEXT_PUBLIC_SUPABASE_URL=your-project-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
```

## 実装されたファイル

### フロントエンド

- `app/login/page.tsx` - ログイン/新規登録ページ
- `app/mypage/page.tsx` - マイページ（会員情報・カート）
- `components/Header.tsx` - デスクトップヘッダー（ログイン機能統合）
- `components/MobileHeader.tsx` - モバイルヘッダー（ログイン機能統合）

### バックエンド（API）

- `app/api/users/profile/route.ts` - ユーザープロフィールAPI
- `app/api/cart/route.ts` - カートAPI

### データベース

- `supabase-user-schema.sql` - データベーススキーマ定義

## 使用方法

### 1. 新規登録

1. ヘッダーの「ログイン」ボタンをクリック
2. 「新規登録はこちら」をクリック
3. メールアドレスとパスワードを入力
4. 「新規登録」ボタンをクリック
5. 確認メールが送信されるので、メール内のリンクをクリックして認証を完了

### 2. ログイン

1. ヘッダーの「ログイン」ボタンをクリック
2. メールアドレスとパスワードを入力
3. 「ログイン」ボタンをクリック

### 3. マイページ

ログイン後、ヘッダーの「マイページ」ボタンからアクセスできます。

#### 会員情報タブ
- 氏名、フリガナ、電話番号、住所などの情報を登録・更新できます

#### カートタブ
- カート内の商品を確認・管理できます
- 数量の変更、商品の削除が可能です
- 「購入手続きへ進む」ボタンから購入ページに遷移できます

## セキュリティ

- **Row Level Security (RLS)**: ユーザーは自分のデータのみアクセス可能
- **Supabase Auth**: 認証はSupabase Authを使用して安全に管理
- **セッション管理**: クライアント側でセッションを管理

## 今後の拡張

以下の機能を追加できます：

1. **メニュー一覧ページへのカート追加機能**
   - メニューカードに「カートに追加」ボタンを追加
   - ログインしていない場合はログインページにリダイレクト

2. **メニュー詳細ページへのカート追加機能**
   - 詳細ページに「カートに追加」ボタンを追加

3. **注文履歴機能**
   - 過去の注文をマイページで確認できるようにする

4. **お気に入り機能**
   - お気に入りのメニューを保存できるようにする

## トラブルシューティング

### ログインできない場合

1. Supabaseの環境変数が正しく設定されているか確認
2. データベーススキーマが正しく実行されているか確認
3. ブラウザのコンソールでエラーを確認

### カートが表示されない場合

1. ログインしているか確認
2. データベースの `carts` テーブルが作成されているか確認
3. RLSポリシーが正しく設定されているか確認

### プロフィールが更新できない場合

1. ログインしているか確認
2. データベースの `user_profiles` テーブルが作成されているか確認
3. RLSポリシーが正しく設定されているか確認

## 参考資料

- [Supabase Auth Documentation](https://supabase.com/docs/guides/auth)
- [Row Level Security Documentation](https://supabase.com/docs/guides/auth/row-level-security)

